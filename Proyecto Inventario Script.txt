--TABLAS DE PRODUCTO
CREATE TABLE PRODUCTO ( 
	PROD_ID SERIAL PRIMARY KEY UNIQUE,
	PROD_NAME VARCHAR(30) NOT NULL,
	PROD_DESCRIP VARCHAR(100),
	PROD_CANTIDAD INTEGER,
	PROD_PRECIO FLOAT,
	PROD_TPROD_ID INTEGER,
	PROD_PROV_ID INTEGER,
	PROD_DEPART_ID INTEGER
);

CREATE TABLE TIPO_PRODUCTO ( 
	TPROD_ID SERIAL PRIMARY KEY UNIQUE,
	TPROD_NAME VARCHAR(20) NOT NULL
);

--TABLAS DE PROVEEDOR
CREATE TABLE PROVEEDOR ( 
	PROV_ID SERIAL PRIMARY KEY UNIQUE,
	PROV_VENDNM VARCHAR(50) NOT NULL,
	PROV_TELF VARCHAR(100),
	PROV_EMPRENM VARCHAR(50) NOT NULL,
	PROV_TPROV_ID INTEGER
);

CREATE TABLE TIPO_PROVEEDOR ( 
	TPROV_ID SERIAL PRIMARY KEY UNIQUE,
	TPROV_NAME VARCHAR(20) NOT NULL
);

--RELACION DE PROVEEDOR
ALTER TABLE PROVEEDOR ADD CONSTRAINT PROV_TPROV_ID_FK FOREIGN KEY (PROV_TPROV_ID) REFERENCES TIPO_PROVEEDOR (TPROV_ID) 
ON DELETE RESTRICT ON UPDATE CASCADE;

--TABLA DE DEPARTAMENTO
CREATE TABLE DEPARTAMENTO ( 
	DEPART_ID SERIAL PRIMARY KEY UNIQUE,
	DEPART_NAME VARCHAR(50) NOT NULL,
	DEPART_ADMINM VARCHAR(50) NOT NULL,
	DEPART_NUMEROEMP INTEGER,
	DEPART_JERARQUIA VARCHAR(50)
);

--RELACIONES DE PRODUCTO
ALTER TABLE PRODUCTO ADD CONSTRAINT PROD_TPROD_ID_FK FOREIGN KEY (PROD_TPROD_ID) REFERENCES TIPO_PRODUCTO (TPROD_ID) 
ON DELETE RESTRICT ON UPDATE CASCADE;
ALTER TABLE PRODUCTO ADD CONSTRAINT PROD_PROV_ID_FK FOREIGN KEY (PROD_PROV_ID) REFERENCES PROVEEDOR (PROV_ID) 
ON DELETE RESTRICT ON UPDATE CASCADE;
ALTER TABLE PRODUCTO ADD CONSTRAINT PROD_DEPART_ID_FK FOREIGN KEY (PROD_DEPART_ID) REFERENCES DEPARTAMENTO (DEPART_ID) 
ON DELETE RESTRICT ON UPDATE CASCADE;

--TABLAS DE FACTURA
CREATE TABLE FACTURA ( 
	FACT_ID INTEGER PRIMARY KEY UNIQUE,
	FACT_VALOR INTEGER NOT NULL,
	FACT_PROV_ID INTEGER
);

--RELACION DE FACTURA
ALTER TABLE FACTURA ADD CONSTRAINT FACT_PROV_ID_FK FOREIGN KEY (FACT_PROV_ID) REFERENCES PROVEEDOR (PROV_ID) 
ON DELETE RESTRICT ON UPDATE CASCADE;

CREATE TABLE HISTORIAL ( 
  HIS_ID INTEGER PRIMARY KEY UNIQUE,
  HIS_FACT_ID INTEGER NOT NULL,
  HIS_PROD_ID INTEGER NOT NULL,
  HIS_FECHA TIMESTAMP DEFAULT NOW()
);

--RELACIONES DE HISTORIAL
ALTER TABLE HISTORIAL ADD CONSTRAINT HIS_FACT_ID_FK FOREIGN KEY (HIS_FACT_ID) REFERENCES FACTURA (FACT_ID) 
ON DELETE RESTRICT ON UPDATE CASCADE;
ALTER TABLE HISTORIAL ADD CONSTRAINT HIS_PROD_ID_FK FOREIGN KEY (HIS_PROD_ID) REFERENCES PRODUCTO (PROD_ID) 
ON DELETE RESTRICT ON UPDATE CASCADE;

--BORRAR TABLAS POR SI ACASO
DROP TABLE PRODUCTO;
DROP TABLE PROVEEDOR;
DROP TABLE DEPARTAMENTO;
DROP TABLE TIPO_PRODUCTO;
DROP TABLE TIPO_PROVEEDOR;

--REINICIAR SECUENCIA DE SERIAL
ALTER SEQUENCE PROVEEDOR_PROV_ID_SEQ RESTART WITH 1;
--OTRA OPCION DE REINICIO
SELECT pg_get_serial_sequence('proveedor', 'prov_id');
SELECT setval(pg_get_serial_sequence('proveedor', 'prov_id'), coalesce(max(2),0) + 1, false) FROM proveedor;